# Наблюдения
* В схеме указано, покупка предмета за монеты происходит через `GET /api/buy/{item}`. Это вызывает вопросы, потому, что GET запрос не должен изменять данные на сервере, а только возвращать их. Решение: Делаем реализацию через POST запрос. Для GET делаем фоллбэк на случай, если уже существует клиент, который почему-то ориентируется на GET, но помечаем его как deprecated.
* Названия эндпойнтов тоже не совсем соответствуют REST (глаголы вместо существительных), но переделывать все ручки в рамках задачи не будет осмысленным, просто отметим этот факт.
* Названия полей в схеме должны быть в формате to_user, а не toUser, и линтеры на это тоже ругаются. Но оставим как есть, ибо ТЗ.
* API указано с префиксом просто `/api`, без версионирования. Это повлечёт за собой некоторую боль в будущем, когда понадобится реализовать изменения, ломающие совместимость. Решение: монтируем API по префиксу `/api/` и префиксу `/api/v1/`

# Инструкции
## Запуск приложения в контейнере и запуск тестов
* Для запуска приложения в докере можно воспользоваться командой `make build-restart`, которая пересоберёт контейнеры, запустит базу данных и контейнер с приложением, а также заставит отработать контейнер с миграциями и сидами.
```sh
make build-restart
```
* Запуск тестов `make test`, тест-контейнер с базой данных поднимется и опустится самостоятельно.
```
make test
```
* Просмотр покрытия `make coverage`, предварительно нужен хотя бы один прогон тестов, чтобы появился файл с покрытием.
```
make coverage
```
* Запуск линтера
```
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
make lint
```
## Запуск приложения локально (для разработки)
* Установить модули
```
go mod download
```
* Приложение поддерживает `.env` файл с переменными окружения. См. пример `.env.example`. Можно переименовать его «как есть» и добавить туда нужные параметры базы данных.
```
cp .env .env.example
```
* Для миграций используется goose, инструкции по запуску миграций — ниже по файлу.
```
go install github.com/pressly/goose/v3/cmd/goose@latest
```
* Запуск сервера
```
go run main.go
## Нагрузочное тестирование
Должны быть запущены контейнеры с приложением, установлены jq и oha.
```
make load-test
```
```

# Замечания по реализации
* Для того, чтобы можно было начислять монеты, добавлен эндпойнт `POST /api/credit`, доступный только пользователям с ролью admin (определяется по полю `role` в таблице `users`).
* Админский пользователь  с логином `director` и паролем `password` создаётся при загрузке seed-данных (в сидах привязка к секретному JWT ключу из `.env.example`)
* Для начисления нужно указать добавляемую сумму в поле `amount`. Отрицательные суммы тоже можно указывать, но списан будет максимум тот баланс, который есть у пользователя.
```
POST /api/v1/credit
Authorization: Bearer your_admin_user_token

{
  "username": "employee",
  "amount": 1000
}
```

* И транзакции и у заказа в базе данных есть своё поле `user_id`. В текущей логике это может привести к рассогласованию данных, когда вещь передана одному человеку, а деньги списаны со счёта другого. Но это даёт гибкость для будущих реализаций, например если нужно будет реализовать дарение вещи, а не просто передачу монеток.
* Для сущности `Info` (отчёт о монетах, инвентаре и транзакциях) прописаны теги для json и db. Вообще, им наверное не место в предметной области, но добавлять слои моделей и презентеров для такого небольшого проекта кажется оверинжинирингом. Будем считать, что для отчёта это окей.
* Эндпойнты со слешом на конце (`/auth/` и `/auth` например) реализованы как редиректы с первого на второй. При проверке нужно указать это клиенту (например `curl -L -X POST...`).

# Версии и требования
* Go 1.24
* Для E2E тестов используются тест-контейнеры с Постгресом, поэтому для запуска тестов нужно, чтобы на машине был Докер.



# Миграции при помощи goose
Проверить
```
goose postgres "postgres://prepin:@localhost:5432/av-merch-shop?sslmode=disable" -dir=schema/migrations status
```
Запустить
```
goose postgres "postgres://prepin:@localhost:5432/av-merch-shop?sslmode=disable" -dir=schema/migrations up
```

Сиды
```
goose postgres "postgres://prepin:@localhost:5432/av-merch-shop?sslmode=disable" -dir=schema/seed/ -no-versioning up

goose postgres "postgres://prepin:@localhost:5432/av-merch-shop?sslmode=disable" -dir=schema/seed -no-versioning reset
```


# Полезные файлы
* [Человекочитаемая OpenAPI cхема](docs/redoc.static.html)
